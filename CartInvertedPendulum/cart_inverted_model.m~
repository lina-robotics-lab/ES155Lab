classdef cart_inverted_model
   properties
        g=9.81;
        mp=.23;
        l=.6413;
        r=0;
        J=0;
        gamma=.024;
        mc=.38;
        c=0.9;
        M=0;
        R=0;
        K=0;
        sa0 = [0;0;0;0];
        x = [0;0;0;0];
   end
   methods
      function obj = cart_inverted_model(state0,g,mp,l,r,J,gamma,mc,c)
          obj.state0 = state0;
          obj.state = state0;
          
          obj.g = g;
          obj.mp = mp;
          obj.l = l;
          obj.r = r;
          obj.J = J;
          obj.gamma = gamma;
          obj.mc = mc;
          obj.c = c;
          
        obj.M=mc+mp;
        obj.R=mp*r;
        obj.K=J+mp*r^2;

      end
      function obj=simulate(obj,u,time_duration)
          % Simulate the system under the influence of input u for
          % time_duration amount of time.
        
        x0 = obj.state;      
        params = {obj.g, obj.M, obj.R, obj.K, obj.c, obj.gamma} ;

        Tspan = [0 time_duration];
        
        % time domain ODE simulaiton
        [t,x] = ode45(@(t,x) stateTransFunc(t,x,u,params),Tspan,x0);        
        
        % Update the object state.
        obj.state = x(end);
        
        % The local helper function
        function xdot=stateTransFunc(t,x,u,params)
            [g, M, R, K, c, gamma] = params{:} ;
            % State vector s=(x,theta, dx/dt,dtheta/dt)
            F = u;
            v = x(3);
            theta = x(2);
            omega = x(4);

            xdot = [0; 0; 0; 0];
            xdot(1)=x(3);
            xdot(2)=x(4);

            xdot(4) = M*gamma*omega - M*g*R*sin(theta) + (F-c*v+R*sin(theta)*omega^2)*R*cos(theta);
            xdot(4) = xdot(4)/(R^2*cos(theta)^2-M*K);

        %     xdot(3) = (R*g*sin(theta)-gamma*omega-K*xdot(4))/(R*cos(theta)) ;
            xdot(3) = R^2*g*sin(theta)*cos(theta)-K*(F-c*v+R*sin(theta)*omega^2)-gamma*R*omega*cos(theta);
            xdot(3) = xdot(3)/(R^2*cos(theta)^2-M*K);
        end
      end
   end
end